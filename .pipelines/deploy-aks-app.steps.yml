parameters:
- name: imageTag
  type: string
  default: '0.0.1'

steps:
- checkout: self
- task: KubernetesManifest@0
  displayName: Create imagePullSecret
  inputs:
    action: createSecret
    secretName: $(imagePullSecret)
    dockerRegistryEndpoint: $(dockerRegistryServiceConnection)

- task: KubernetesManifest@0
  displayName: Deploy to Kubernetes cluster
  inputs:
    action: deploy
    manifests: |
      $(Build.SourcesDirectory)/src/rose/k8s/pipeline/rose-app-dep.yml
      $(Build.SourcesDirectory)/src/rose/k8s/pipeline/rose-app-svc.yml
      $(Build.SourcesDirectory)/src/rose/k8s/pipeline/rose-app-hpa-cpu.yml
    imagePullSecrets: |
      $(imagePullSecret)
    containers: |
      $(containerRegistry)/$(imageRepository):${{ parameters.imageTag }}
