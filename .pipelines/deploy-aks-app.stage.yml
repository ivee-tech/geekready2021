parameters:
- name: env
  type: string
  default: dev
- name: varGroup
  type: string
  default: aks-deploy-dev
- name: imageTag
  type: string
  default: '0.0.1'


stages:
  - stage: 'deploy-${{ parameters.env }}'
    displayName: Deploy in ${{ parameters.env }} env
    variables: 
    - group: ${{ parameters.varGroup }}
    jobs:
    - deployment: Deploy
      displayName: Deploy
      pool:
        vmImage: $(vmImageName)
      environment: '$(environment)'
      strategy:
        runOnce:
          deploy:
            steps:
            - checkout: self
            - task: KubernetesManifest@0
              displayName: Create imagePullSecret
              inputs:
                action: createSecret
                secretName: $(imagePullSecret)
                dockerRegistryEndpoint: $(dockerRegistryServiceConnection)

            - task: KubernetesManifest@0
              displayName: Deploy to Kubernetes cluster
              inputs:
                action: deploy
                manifests: |
                  $(Build.SourcesDirectory)/src/rose/k8s/pipeline/rose-app-dep.yml
                  $(Build.SourcesDirectory)/src/rose/k8s/pipeline/rose-app-svc.yml
                  $(Build.SourcesDirectory)/src/rose/k8s/pipeline/rose-app-hpa-cpu.yml
                imagePullSecrets: |
                  $(imagePullSecret)
                containers: |
                  $(containerRegistry)/$(imageRepository):${{ parameters.imageTag }}
